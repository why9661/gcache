# 分布式缓存



## 缓存淘汰策略



### 简介

LRU(Least Recently Used)即“最近最少使用”，是一种相对平衡的缓存淘汰算法。其维护一个队列，如果新增或修改某条记录，则将该条记录移动到队尾，队首即为最近最少使用的记录，淘汰该条记录。



### 实现

核心的数据结构：map以及container包中实现的双向循环链表list。

+ map存储key-value的映射关系
+ list维护记录队列



## 单机并发缓存

使用sync.Mutex封装lru的方法使其支持安全的并发读写。



## 分布式节点

基于HTTP的节点间通信机制是比较常见和简单的做法。如果一个节点启动了 HTTP 服务，那么这个节点就可以被其他节点访问。

使用一致性哈希算法来选择节点，在节点发生变化时避免缓存雪崩。



## 防止缓存击穿

使用 singleflight 机制防止缓存击穿。

使用singleflight，第一个get(key)请求到来时，singleflight会记录当前key正在被处理，后续的请求只需要等待第一个请求处理完成，取返回值即可。



# 附录



## 接口型函数

函数类型实现某一个接口，称之为接口型函数，方便使用者在调用时既能够传入函数作为参数（需要类型转换），也能够传入实现了该接口的结构体作为参数。



## 一致性哈希

一致性哈希算法将key和节点映射到一个首尾相连有序的环上。

+ 计算节点的哈希放在环上。

+ 计算key的哈希放在环上，顺序针寻找到的第一个节点就是应该选取的节点。

  

如果节点过少，容易引起 key 的倾斜，造成负载不均衡，此时可以使用虚拟节点，一个真实节点可以映射到多个虚拟节点。

+ 计算虚拟节点的哈希放在环上。
+ 计算key的哈希放在环上，顺序针寻找到的第一个节点就是应该选取的虚拟节点。
+ 通过映射关系找到虚拟节点对应的真实节点。



## 缓存雪崩、缓存击穿、缓存穿透

+ 缓存雪崩

  缓存在同一时刻全部失效，造成瞬时DB请求量大、压力骤增，引起雪崩。缓存雪崩通常因为缓存服务器宕机、缓存的 key 设置了相同的过期时间等引起。

  

+ 缓存击穿

  一个存在的key，在缓存过期的一刻，同时有大量的请求，这些请求都会击穿到 DB ，造成瞬时DB请求量大、压力骤增。

  

+ 缓存穿透

  查询一个不存在的数据，因为不存在则不会写到缓存中，所以每次都会去请求 DB，如果瞬间流量过大，穿透到 DB，导致宕机。